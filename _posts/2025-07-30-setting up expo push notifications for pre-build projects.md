---
layout: post
title: Setting up Expo Push Notifications for Pre-Build Projects
date: 2025-07-30
categories: post
permalink: /:title/
image: /assets/oscar.jpg
---

I recently had to set up Expo Push Notifications. Their tutorial though is mostly aimed to be used with EAS Build, which I don't use, I use `prebuild`. I also could not use `eas credentials` because I use a YubiKey, which kills the integration with the apple account. So here are some manual steps that should get it to work easily.

## iOS

- I'm using a YubiKey and also doing pre-build. Automatic setup via `eas credentials` does not work because of the YubiKey and pre-build (AFAIK) does not work with EAS Build.
- Create an Apple Push Notification Service key. This key is for ALL of the apps in the organization
  1.  Go to https://developer.apple.com/account and log in.
  2.  Navigate to "keys"
  3.  Register new key
  4.  Select Apple Push Notifications service
  5.  Select BOTH sandbox and production ⚠️
  6.  Create key, download p8 and copy the key id
- Take that p8 file and the key id and upload it to the `credentials` section of `expo.dev` in the `Push Key` section
- Install the deps

```bash
bunx expo install expo-notifications expo-device expo-constants
```

- Add `expo-notifications` to the list of plugins on `app.config.ts`
- Make sure on `app.config.ts` this section is set. Your project id you can find in the expo project settings.

```json
    extra: {
      eas: {
        projectId: "foo-a-uuid-quack",
      },
    },
```

- You can copy the [minimal reproduction snippet](https://docs.expo.dev/push-notifications/push-notifications-setup/#add-a-minimal-working-example). The most important part is getting the device token (`expoPushToken`)
- In the snippet the so called `expoPushToken` is, confusingly, an device push token. The token that identifies the device to send push notifications. You will need to use that to send notification to device
- Test via their [online tool](https://expo.dev/notifications)
- For production, on app start get the `expoPushToken` and send it to your backend to be stored on the user entity. Then you can configure their library to send notifications to particular devices.
  - How to handle device de-registration? I guess there might be some on-uninstall hook?

## Android

Following the [Obtain Google Service Account Keys using FCM v1](https://docs.expo.dev/push-notifications/fcm-credentials/) works. There is, however, things to watch out for:

- Adding the expo dependencies with a pre-build generation adds all the native code.
- I was testing with the `.jks` generated by expo (downloaded via `eas credentials`, I was just testing other stuff) and when the app started I got an error saying that `firebase was not initialized`, confusing as I did not add any firebase code to the app. Once I did a new `prebuild` and just left the default generated Keystore notifications worked.
- The expo docs say **not to commit the google-services.json** and there are [lenghty workarounds](https://github.com/expo/eas-cli/issues/228) by putting it in a EAS secret and then generating the file on the build steps or using a new file upload as secrets. However, on Google Groups a [Firebase Mantainer](https://groups.google.com/g/firebase-talk/c/bamCgTDajkw/m/uVEJXjtiBwAJ%29) has confirmed it's not necessary to keep it secret. As long as the rules are set up correctly everything will be fine. ALSO, the fact that it is embedded in the APK means any ~~idiot~~ bad actor can decompile the APK and extract it anyways, so you might as well just commit it and save yourself the trouble.
