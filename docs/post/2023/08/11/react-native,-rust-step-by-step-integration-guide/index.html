<head>
  <link rel="preconnect" href="https://rsms.me/" />
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="utf-8" />
  <link
    rel="shortcut icon"
    type="image/x-icon"
    href="/assets/favicon.ico"
  />
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>React Native, Rust step-by-step integration guide | Oscar Franco</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="React Native, Rust step-by-step integration guide" />
<meta name="author" content="Oscar Franco" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="There are many talks and tutorials that go over the more advanced topics once people have integrated Rust into their projects, however, if you are like me and have no idea about how to build, link and include your Rust code, they really convey little information." />
<meta property="og:description" content="There are many talks and tutorials that go over the more advanced topics once people have integrated Rust into their projects, however, if you are like me and have no idea about how to build, link and include your Rust code, they really convey little information." />
<link rel="canonical" href="https://ospfranco.com/post/2023/08/11/react-native,-rust-step-by-step-integration-guide/" />
<meta property="og:url" content="https://ospfranco.com/post/2023/08/11/react-native,-rust-step-by-step-integration-guide/" />
<meta property="og:site_name" content="Oscar Franco" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-08-11T15:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="React Native, Rust step-by-step integration guide" />
<meta name="twitter:site" content="@ospfranco" />
<meta name="twitter:creator" content="@Oscar Franco" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Oscar Franco"},"dateModified":"2023-08-11T15:00:00+02:00","datePublished":"2023-08-11T15:00:00+02:00","description":"There are many talks and tutorials that go over the more advanced topics once people have integrated Rust into their projects, however, if you are like me and have no idea about how to build, link and include your Rust code, they really convey little information.","headline":"React Native, Rust step-by-step integration guide","mainEntityOfPage":{"@type":"WebPage","@id":"https://ospfranco.com/post/2023/08/11/react-native,-rust-step-by-step-integration-guide/"},"url":"https://ospfranco.com/post/2023/08/11/react-native,-rust-step-by-step-integration-guide/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/css/site.css" />
</head>

<html>
  <header
  class="w-full flex justify-center pt-4 pb-4 bg-white dark:bg-black fixed top-0 border-b border-gray-100 dark:border-neutral-800"
>
  <div class="w-full max-w-3xl flex items-center gap-2 px-4">
    <a href="/" class="font-semibold flex-1 text-black dark:text-white"
      >Oscar Franco</a
    >

    <!-- <div class="h-2 w-2 rounded-full bg-green-400 animate-pulse"></div>
    <a href="mailto:ospfranco@gmail.com"
    target="_blank" class="text-sm">
      Available for freelance work
    </a> -->
  </div>
</header>


<body class="flex flex-col items-center">
  <div class="px-4 pt-24 min-h-screen xl:max-w-3xl w-full">
    <div class="xl:mx-auto flex flex-col">
      <h1 class="text-black dark:text-white text-2xl sm:text-4xl font-semibold">
        React Native, Rust step-by-step integration guide
      </h1>

      <p class="mt-2 text-neutral-500">August 2023</p>

      <div class="pt-4 pb-20 markdown"><p>There are many talks and tutorials that go over the more advanced topics once people have integrated Rust into their projects, however, if you are like me and have no idea about how to build, link and include your Rust code, they really convey little information.</p>

<p>Here is a more step by step tutorial, but in the video form I go over the concepts that actually make this work, so you can adjust and understand the tooling behind and you can maintain your integration.</p>

<iframe class="w-full h-96" src="https://www.youtube.com/embed/PPU4Hrz4J_s" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>

<blockquote>
  <p>I’m currently looking for freelance projects, if your team needs a RN developer or some consulting, <a href="mailto://ospfranco@gmail.com">send me an email</a>.</p>
</blockquote>

<h1 id="basic-setup-and-ios">Basic Setup and iOS</h1>

<ul>
  <li>Set up Rust compiler on your computer, just follow the instructions on the Rust website.</li>
  <li>
    <p>Set up cross compilation targets, 32 bits targets are no longer supported, so we will only add those usable in 2023.</p>

    <ul>
      <li>32bit targets have been deprecated by the rust team, no longer available on the stable channel</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rustup target add x86_64-apple-ios
rustup target add aarch64-apple-ios
rustup target add aarch64-apple-ios-sim

rustup target add x86_64-linux-android
rustup target add aarch64-linux-android
rustup target add armv7-linux-androideabi
rustup target add i686-linux-android
</code></pre></div>    </div>
  </li>
  <li>
    <p>Next we will create the folder where we will put all of our Rust code and infra scripts. In my case I will call it <code class="language-plaintext highlighter-rouge">my_sdk</code></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo new <span class="o">[</span>YOUR_LIBRARY_NAME]
</code></pre></div>    </div>
  </li>
  <li>Change name of <code class="language-plaintext highlighter-rouge">main.rs</code> to <code class="language-plaintext highlighter-rouge">lib.rs</code></li>
  <li>Add your API code on lib.rs</li>
  <li>Add cbindgen crate (alternative is cxx.rs) <code class="language-plaintext highlighter-rouge">cargo install cbindgen</code></li>
  <li>Create a <code class="language-plaintext highlighter-rouge">cbindgen.toml</code> file, it is fine if it is empty.</li>
  <li><code class="language-plaintext highlighter-rouge">cbindgen --config cbindgen.toml --crate my_sdk --output include/my_sdk.h</code></li>
  <li>
    <p>Modify toml to compile as static library for iOS and a dynamic library with JNI linked for Android</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>package]
name <span class="o">=</span> <span class="s2">"SDK"</span>
version <span class="o">=</span> <span class="s2">"0.1.0"</span>
edition <span class="o">=</span> <span class="s2">"2021"</span>

<span class="o">[</span>lib]
name <span class="o">=</span> <span class="s2">"SDK"</span>
crate-type <span class="o">=</span> <span class="o">[</span><span class="s2">"staticlib"</span>, <span class="s2">"cdylib"</span><span class="o">]</span>

<span class="o">[</span>dependencies]
libc <span class="o">=</span> <span class="s2">"0.2.80"</span>
jni <span class="o">=</span> <span class="s2">"0.17.0"</span>

<span class="o">[</span>features]
default <span class="o">=</span> <span class="o">[</span><span class="s2">"jni"</span><span class="o">]</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Setup Makefile</p>

    <div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ARCHS_IOS</span> <span class="o">=</span> x86_64-apple-ios aarch64-apple-ios aarch64-apple-ios-sim
<span class="nv">ARCHS_ANDROID</span> <span class="o">=</span> aarch64-linux-android armv7-linux-androideabi i686-linux-android
<span class="nv">LIB</span> <span class="o">=</span> libmy_sdk.a
<span class="nv">XCFRAMEWORK</span> <span class="o">=</span> MySdk.xcframework

<span class="nl">all</span><span class="o">:</span> <span class="nf">ios android</span>

<span class="nl">ios</span><span class="o">:</span> <span class="nf">$(XCFRAMEWORK)</span>

<span class="nl">android</span><span class="o">:</span> <span class="nf">$(ARCHS_ANDROID)</span>
	sh copy_android.sh

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">$(ARCHS_IOS)</span>
<span class="nl">$(ARCHS_IOS)</span><span class="o">:</span> <span class="nf">%:</span>
	cargo build <span class="nt">--target</span> <span class="nv">$@</span> <span class="nt">--release</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">$(ARCHS_ANDROID)</span>
<span class="nl">$(ARCHS_ANDROID)</span><span class="o">:</span> <span class="nf">%:</span>
	cargo build <span class="nt">--target</span> <span class="nv">$@</span> <span class="nt">--release</span>

<span class="nl">$(XCFRAMEWORK)</span><span class="o">:</span> <span class="nf">$(ARCHS_IOS)</span>
	lipo <span class="nt">-create</span> <span class="p">$(</span>wildcard target/x86_64-apple-ios/release/<span class="p">$(</span>LIB<span class="p">))</span> <span class="p">$(</span>wildcard target/aarch64-apple-ios-sim/release/<span class="p">$(</span>LIB<span class="p">))</span> <span class="nt">-output</span> simulator_fat/libmy_sdk.a
	xcodebuild <span class="nt">-create-xcframework</span> <span class="nt">-library</span> <span class="p">$(</span>wildcard target/aarch64-apple-ios/release/<span class="p">$(</span>LIB<span class="p">))</span> <span class="nt">-headers</span> include <span class="nt">-library</span> simulator_fat/libmy_sdk.a <span class="nt">-headers</span> include <span class="nt">-output</span> <span class="nv">$@</span>
</code></pre></div>    </div>
  </li>
  <li>Add generated <code class="language-plaintext highlighter-rouge">.xcframework</code> to Xcode (dragging and dropping is the easiest)
    <ul>
      <li>On the project properties mark the xcframework as embed and sign</li>
    </ul>
  </li>
  <li>You should now be able to simply import the header file and call the rust function from any obj-c++ file</li>
</ul>

<h1 id="android">Android</h1>

<ul>
  <li>
    <p>On cargo.toml add the <code class="language-plaintext highlighter-rouge">cdylib</code> crate-type, plus the features and make it optional so that it doesn’t intefere with iOS</p>

    <div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">[package]</span>
<span class="nv">name</span> <span class="o">=</span> <span class="s2">"my_sdk"</span>
<span class="nv">version</span> <span class="o">=</span> <span class="s2">"0.1.0"</span>
<span class="nv">edition</span> <span class="o">=</span> <span class="s2">"2021"</span>

<span class="err">[lib]</span>
<span class="nv">name</span> <span class="o">=</span> <span class="s2">"my_sdk"</span>
<span class="nv">crate-type</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"staticlib"</span>, <span class="s2">"cdylib"</span><span class="o">]</span>

<span class="err">[dependencies]</span>
<span class="nv">libc</span> <span class="o">=</span> <span class="s2">"0.2.80"</span>
<span class="nv">jni</span> <span class="o">=</span> <span class="o">{</span> version <span class="o">=</span> <span class="s2">"0.18.0"</span>, optional <span class="o">=</span> <span class="nb">true</span>, default-features <span class="o">=</span> <span class="nb">false</span> <span class="o">}</span>

<span class="err">[features]</span>
<span class="nv">default</span> <span class="o">=</span> <span class="o">[</span><span class="s2">"jni"</span><span class="o">]</span>
</code></pre></div>    </div>
  </li>
  <li>Android unfortunately requires its own linker, some of the old tutorials mention using a script inside the sdk to generate a standalone toolchain, on the latest versions of the Android SDK there are pre-compiled versions for windows, linux and mac, on my machine I can find them on <code class="language-plaintext highlighter-rouge">~/Library/Android/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/darwin-x86_64/bin</code>. Take note of the version since version 24 of the Android SDK is the one that supports m1 machines.</li>
  <li>
    <p>What we need to do then is tell the Rust compiler to use some of this binaries to compile our rust code, to do this we will create a cargo-config.toml file on our folder, but then we need to copy this into our home folder in the machine since this is a global configuration file:</p>

    <div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># template file on &lt;project&gt;/my_sdk/cargo-config.toml</span>
<span class="c"># All paths are relative to the user home folder</span>
<span class="nn">[target.aarch64-linux-android]</span>
<span class="py">ar</span> <span class="p">=</span> <span class="s">"Library/Android/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android-ar"</span>
<span class="py">linker</span> <span class="p">=</span> <span class="s">"Library/Android/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android31-clang"</span>

<span class="c"># Take note, the target the binary names do not match on this case</span>
<span class="nn">[target.arm-linux-androideabi]</span>
<span class="py">ar</span> <span class="p">=</span> <span class="s">"Library/Android/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/darwin-x86_64/bin/armv7a-linux-androideabi-ar"</span>
<span class="py">linker</span> <span class="p">=</span> <span class="s">"Library/Android/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/darwin-x86_64/bin/armv7a-linux-androideabi31-clang"</span>

<span class="nn">[target.i686-linux-android]</span>
<span class="py">ar</span> <span class="p">=</span> <span class="s">"Library/Android/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/darwin-x86_64/bin/i686-linux-android-ar"</span>
<span class="py">linker</span> <span class="p">=</span> <span class="s">"Library/Android/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/darwin-x86_64/bin/i686-linux-android31-clang"</span>

<span class="nn">[target.x86_64-linux-android]</span>
<span class="py">ar</span> <span class="p">=</span> <span class="s">"Library/Android/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/darwin-x86_64/bin/x86_64-linux-android-ar"</span>
<span class="py">linker</span> <span class="p">=</span> <span class="s">"Library/Android/sdk/ndk/24.0.8215888/toolchains/llvm/prebuilt/darwin-x86_64/bin/x86_64-linux-android31-clang"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Once you have this file, copy it to the home folder via</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp </span>cargo-config.toml ~/.cargo/config
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now we actually have to to compile Rust for android, unlike for iOS, Android requires more flags, instead of doing this via make file a bash script is a little simpler. First modify the Makefile and then create a new <code class="language-plaintext highlighter-rouge">build-android.sh</code> script (don’t forget to give it permissions).</p>

    <div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ARCHS_IOS</span> <span class="o">=</span> x86_64-apple-ios aarch64-apple-ios aarch64-apple-ios-sim
<span class="nv">ARCHS_ANDROID</span> <span class="o">=</span> i686-linux-android x86_64-linux-android aarch64-linux-android arm-linux-androideabi
<span class="nv">LIB</span> <span class="o">=</span> libmy_sdk.a
<span class="nv">XCFRAMEWORK</span> <span class="o">=</span> MySdk.xcframework

<span class="nl">all</span><span class="o">:</span> <span class="nf">ios android</span>

<span class="nl">ios</span><span class="o">:</span> <span class="nf">$(XCFRAMEWORK)</span>

<span class="nl">android</span><span class="o">:</span> <span class="nf">$(ARCHS_ANDROID)</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">$(ARCHS_IOS)</span>
<span class="nl">$(ARCHS_IOS)</span><span class="o">:</span> <span class="nf">%:</span>
  <span class="err">cargo</span> <span class="err">build</span> <span class="err">--target</span> <span class="err">$@</span> <span class="err">--release</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">$(ARCHS_ANDROID)</span>
<span class="nl">$(ARCHS_ANDROID)</span><span class="o">:</span> <span class="nf">%:</span>
  <span class="err">./build-android.sh</span> <span class="err">$@</span> <span class="c"># Change this!!!!!!!!!
</span>
<span class="nl">$(XCFRAMEWORK)</span><span class="o">:</span> <span class="nf">$(ARCHS_IOS)</span>
  <span class="err">lipo</span> <span class="err">-create</span> <span class="nf">$(</span><span class="nb">wildcard</span> target/x86_64-apple-ios/release/<span class="p">$(</span>LIB<span class="p">))</span> <span class="nf">$(</span><span class="nb">wildcard</span> target/aarch64-apple-ios-sim/release/<span class="p">$(</span>LIB<span class="p">))</span> <span class="err">-output</span> <span class="err">simulator_fat/libmy_sdk.a</span>
  <span class="err">xcodebuild</span> <span class="err">-create-xcframework</span> <span class="err">-library</span> <span class="nf">$(</span><span class="nb">wildcard</span> target/aarch64-apple-ios/release/<span class="p">$(</span>LIB<span class="p">))</span> <span class="err">-headers</span> <span class="k">include</span><span class="sx"> -library simulator_fat/libmy_sdk.a -headers include -output $@</span>
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">TARGET</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$TARGET</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"missing argument TARGET"</span>
    <span class="nb">echo</span> <span class="s2">"Usage: </span><span class="nv">$0</span><span class="s2"> TARGET"</span>
    <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">NDK_TARGET</span><span class="o">=</span><span class="nv">$TARGET</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$TARGET</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"arm-linux-androideabi"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">NDK_TARGET</span><span class="o">=</span><span class="s2">"armv7a-linux-androideabi"</span>
<span class="k">fi

</span><span class="nv">API_VERSION</span><span class="o">=</span><span class="s2">"21"</span>
<span class="nv">NDK_VERSION</span><span class="o">=</span><span class="s2">"24.0.8215888"</span>
<span class="nv">NDK_HOST</span><span class="o">=</span><span class="s2">"darwin-x86_64"</span>

<span class="c"># needed so we can overwrite it in the CI</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$NDK</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">NDK</span><span class="o">=</span><span class="s2">"</span><span class="nv">$ANDROID_HOME</span><span class="s2">/ndk/</span><span class="nv">$NDK_VERSION</span><span class="s2">"</span>
<span class="k">fi

</span><span class="nv">TOOLS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$NDK</span><span class="s2">/toolchains/llvm/prebuilt/</span><span class="nv">$NDK_HOST</span><span class="s2">"</span>

<span class="nv">AR</span><span class="o">=</span><span class="nv">$TOOLS</span>/bin/llvm-ar <span class="se">\</span>
<span class="nv">CXX</span><span class="o">=</span><span class="nv">$TOOLS</span>/bin/<span class="k">${</span><span class="nv">NDK_TARGET</span><span class="k">}${</span><span class="nv">API_VERSION</span><span class="k">}</span><span class="nt">-clang</span>++ <span class="se">\</span>
<span class="nv">RANLIB</span><span class="o">=</span><span class="nv">$TOOLS</span>/bin/llvm-ranlib <span class="se">\</span>
<span class="nv">CXXFLAGS</span><span class="o">=</span><span class="s2">"--target=</span><span class="nv">$NDK_TARGET</span><span class="s2">"</span> <span class="se">\</span>
cargo build <span class="nt">--target</span> <span class="nv">$TARGET</span> <span class="nt">--release</span> <span class="nv">$EXTRA_ARGS</span>
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>This method of compilation was developed by <strong>Nik Graf</strong> and his team at <strong>Serenity Notes</strong>, shot out to them.
<a href="https://www.serenity.re/en/notes">https://serenity.re</a></p>
</blockquote>

<ul>
  <li>
    <p>Ask you can see you need to have set the <code class="language-plaintext highlighter-rouge">$ANDROID_HOME</code> environment variable (I have it on my <code class="language-plaintext highlighter-rouge">.zshrc</code>) you can modify the <code class="language-plaintext highlighter-rouge">API_VERSION</code> and the <code class="language-plaintext highlighter-rouge">NDK_VERSION</code> to the ones you are using and have installed on your machine.</p>
  </li>
  <li>
    <p>We will still not be able to call our Rust code from Java, because we need to go through the JNI and the JNI is very picky regarding names, we need to create specific binding for Android, on the <code class="language-plaintext highlighter-rouge">[lib.rs](http://lib.rs)</code> and the following block</p>
  </li>
  <li>
    <p>We can finally call <code class="language-plaintext highlighter-rouge">make android</code> and the library will be created for us</p>

    <div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// On Android function names need to follow the JNI convention</span>
<span class="k">pub</span> <span class="k">mod</span> <span class="n">android</span> <span class="p">{</span>
  <span class="k">extern</span> <span class="k">crate</span> <span class="n">jni</span><span class="p">;</span>

  <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">jni</span><span class="p">::</span><span class="n">JNIEnv</span><span class="p">;</span>
  <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">jni</span><span class="p">::</span><span class="nn">objects</span><span class="p">::</span><span class="n">JClass</span><span class="p">;</span>
  <span class="k">use</span> <span class="k">self</span><span class="p">::</span><span class="nn">jni</span><span class="p">::</span><span class="nn">sys</span><span class="p">::</span><span class="n">jstring</span><span class="p">;</span>

  <span class="nd">#[no_mangle]</span>
  <span class="k">pub</span> <span class="k">unsafe</span> <span class="k">extern</span> <span class="k">fn</span> <span class="nf">Java_com_samplesdk_BindingsModule_helloWorld</span><span class="p">(</span><span class="n">env</span><span class="p">:</span> <span class="n">JNIEnv</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">JClass</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">jstring</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">env</span><span class="nf">.new_string</span><span class="p">(</span><span class="s">"Hello from Rust!"</span><span class="p">)</span><span class="nf">.expect</span><span class="p">(</span><span class="s">"Couldn't create java string!"</span><span class="p">);</span>
    <span class="n">output</span><span class="nf">.into_inner</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>We now need to somehow include this .so files into the Android compilation, the easiest way is to copy them inside of the <code class="language-plaintext highlighter-rouge">Android/app/src</code> folder and then Gradle should automatically pick them up and include them in the compilation process. Let’s update our make file to include a new script that will copy everything once it is compiled:</p>

    <div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ARCHS_IOS</span> <span class="o">=</span> x86_64-apple-ios aarch64-apple-ios aarch64-apple-ios-sim
<span class="nv">ARCHS_ANDROID</span> <span class="o">=</span> i686-linux-android x86_64-linux-android aarch64-linux-android arm-linux-androideabi
<span class="nv">LIB</span> <span class="o">=</span> libmy_sdk.a
<span class="nv">XCFRAMEWORK</span> <span class="o">=</span> MySdk.xcframework

<span class="nl">all</span><span class="o">:</span> <span class="nf">ios android</span>

<span class="nl">ios</span><span class="o">:</span> <span class="nf">$(XCFRAMEWORK)</span>

<span class="nl">android</span><span class="o">:</span> <span class="nf">GENERATE_ANDROID</span>

<span class="c"># PHONY keyword on make means this is not a file, just an identifier for a target
</span><span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">$(ARCHS_IOS)</span>
<span class="nl">$(ARCHS_IOS)</span><span class="o">:</span> <span class="nf">%:</span>
  <span class="err">cargo</span> <span class="err">build</span> <span class="err">--target</span> <span class="err">$@</span> <span class="err">--release</span>

<span class="nl">$(XCFRAMEWORK)</span><span class="o">:</span> <span class="nf">$(ARCHS_IOS)</span>
  <span class="err">lipo</span> <span class="err">-create</span> <span class="nf">$(</span><span class="nb">wildcard</span> target/x86_64-apple-ios/release/<span class="p">$(</span>LIB<span class="p">))</span> <span class="nf">$(</span><span class="nb">wildcard</span> target/aarch64-apple-ios-sim/release/<span class="p">$(</span>LIB<span class="p">))</span> <span class="err">-output</span> <span class="err">simulator_fat/libmy_sdk.a</span>
  <span class="err">xcodebuild</span> <span class="err">-create-xcframework</span> <span class="err">-library</span> <span class="nf">$(</span><span class="nb">wildcard</span> target/aarch64-apple-ios/release/<span class="p">$(</span>LIB<span class="p">))</span> <span class="err">-headers</span> <span class="k">include</span><span class="sx"> -library simulator_fat/libmy_sdk.a -headers include -output $@</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">$(ARCHS_ANDROID)</span>
<span class="nl">$(ARCHS_ANDROID)</span><span class="o">:</span> <span class="nf">%:</span>
  <span class="err">./build-android.sh</span> <span class="err">$@</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">GENERATE_ANDROID</span>
<span class="nl">GENERATE_ANDROID</span><span class="o">:</span> <span class="nf">$(ARCHS_ANDROID)</span>
  <span class="err">./copy-android.sh</span>

<span class="nl">.PHONY</span><span class="o">:</span> <span class="nf">clean</span>
<span class="nl">clean</span><span class="o">:</span>
  <span class="err">rm</span> <span class="err">-rf</span> <span class="err">target</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>We of course need to create the <code class="language-plaintext highlighter-rouge">[copy-android.sh](http://copy-android.sh)</code> script (don’t forget to give permissions)</p>

    <div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#! /bin/bash
</span><span class="err">mkdir</span> <span class="err">-p</span> <span class="err">../android/app/src/main/jniLibs</span>
<span class="err">mkdir</span> <span class="err">-p</span> <span class="err">../android/app/src/main/jniLibs/x86</span>
<span class="err">mkdir</span> <span class="err">-p</span> <span class="err">../android/app/src/main/jniLibs/arm64-v8a</span>
<span class="err">mkdir</span> <span class="err">-p</span> <span class="err">../android/app/src/main/jniLibs/armeabi-v7a</span>
<span class="c"># missing arm-linux-androideabi here, don't know the name of the arch?
</span>
<span class="err">cp</span> <span class="err">./target/i686-linux-android/release/libmy_sdk.so</span> <span class="err">../android/app/src/main/jniLibs/x86/libmy_sdk.so</span>
<span class="err">cp</span> <span class="err">./target/aarch64-linux-android/release/libmy_sdk.so</span> <span class="err">../android/app/src/main/jniLibs/arm64-v8a/libmy_sdk.so</span>
<span class="err">cp</span> <span class="err">./target/arm-linux-androideabi/release/libmy_sdk.so</span> <span class="err">../android/app/src/main/jniLibs/armeabi-v7a/libmy_sdk.so</span>
<span class="c"># missing x86_64-linux-androideabi here, don't know the name of the arch?
</span>
<span class="err">echo</span> <span class="s2">"Dynamic libraries copied!"</span>
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>Another alternative and also if you are using JSI is using CMakeLists to declare your files as dependencies and or library, then it will automatically be included in the compilation process. You can see one example of this here:
<a href="https://github.com/serenity-kit/react-native-opaque/blob/main/android/CMakeLists.txt">https://github.com/serenity-kit/react-native-opaque/blob/main/android/CMakeLists.txt</a>
However loading .so libraries is a common practice in the Android world, so I think both are fine.</p>
</blockquote>

<ul>
  <li>
    <p>We can now create a RN Module (or JSI module) and simply load the library and call it (via JNI of course)</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.samplesdk</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.facebook.react.bridge.NativeModule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.react.bridge.ReactApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.react.bridge.ReactContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.react.bridge.ReactContextBaseJavaModule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.react.bridge.ReactMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.react.util.RNLog</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BindingsModule</span> <span class="kd">extends</span> <span class="nc">ReactContextBaseJavaModule</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">"my_sdk"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">BindingsModule</span><span class="o">(</span><span class="nc">ReactApplicationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Bindings"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@ReactMethod</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">String</span> <span class="n">apiKey</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RNLog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getReactApplicationContext</span><span class="o">(),</span> <span class="s">"BindingsModule.init() called with apiKey: "</span> <span class="o">+</span> <span class="n">apiKey</span> <span class="o">+</span> <span class="s">"calling rust"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">helloWorld</span><span class="o">();</span>
        <span class="nc">RNLog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getReactApplicationContext</span><span class="o">(),</span> <span class="s">"Rust says: "</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="nc">String</span> <span class="nf">helloWorld</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>
</div>
    </div>

    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

    <script>
      hljs.highlightAll();
    </script>
  </div>
</body>

</html>
