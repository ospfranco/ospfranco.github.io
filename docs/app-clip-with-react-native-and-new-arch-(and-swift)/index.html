<head>
  <link rel="preconnect" href="https://rsms.me/" />
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="utf-8" />
  <link
    rel="shortcut icon"
    type="image/x-icon"
    href="/assets/favicon.ico"
  />
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>App clip with React Native and New Arch (and Swift) | Oscar Franco</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="App clip with React Native and New Arch (and Swift)" />
<meta name="author" content="Oscar Franco" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I had to create an App Clip for a project using React Native. There are people who have done it before, but info is now outdated so posting an updated guide." />
<meta property="og:description" content="I had to create an App Clip for a project using React Native. There are people who have done it before, but info is now outdated so posting an updated guide." />
<link rel="canonical" href="https://ospfranco.com/app-clip-with-react-native-and-new-arch-(and-swift)/" />
<meta property="og:url" content="https://ospfranco.com/app-clip-with-react-native-and-new-arch-(and-swift)/" />
<meta property="og:site_name" content="Oscar Franco" />
<meta property="og:image" content="https://ospfranco.com/assets/oscar.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-30T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://ospfranco.com/assets/oscar.jpg" />
<meta property="twitter:title" content="App clip with React Native and New Arch (and Swift)" />
<meta name="twitter:site" content="@ospfranco" />
<meta name="twitter:creator" content="@Oscar Franco" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Oscar Franco"},"dateModified":"2024-06-30T00:00:00+02:00","datePublished":"2024-06-30T00:00:00+02:00","description":"I had to create an App Clip for a project using React Native. There are people who have done it before, but info is now outdated so posting an updated guide.","headline":"App clip with React Native and New Arch (and Swift)","image":"https://ospfranco.com/assets/oscar.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://ospfranco.com/app-clip-with-react-native-and-new-arch-(and-swift)/"},"url":"https://ospfranco.com/app-clip-with-react-native-and-new-arch-(and-swift)/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/css/site.css" />
</head>

<html>
  <header class="w-full flex flex-col items-center justify-center pt-12 pb-4">
  <!-- <img src="/assets/bg.png" class="" /> -->
  <div class="w-full max-w-4xl flex items-center gap-2 px-4">
    <a href="/" class="flex-1 flex items-center text-black dark:text-white">
      <img src="/assets/oscar.jpg" class="w-8 h-8 rounded-xl mr-2 object-cover" />
      Oscar Franco</a>

    <!-- <div class="h-2 w-2 rounded-full bg-green-400 animate-pulse"></div>
    <a href="mailto:ospfranco@gmail.com"
    target="_blank" class="text-sm">
      Available for freelance work
    </a> -->
  </div>
</header>

<body class="flex flex-col items-center">
  <div class="px-4 pt-8 min-h-screen xl:max-w-4xl w-full">
    <div class="xl:mx-auto flex flex-col">
      <h1 class="text-black dark:text-white text-lg font-semibold sm:text-4xl">
        App clip with React Native and New Arch (and Swift)
      </h1>

      <p class="mt-2 text-neutral-500 text-sm">
        June 2024
      </p>

      <div class="pt-4 pb-20 markdown text-justify"><p>I had to create an App Clip for a project using React Native. There are people who have done it before, but info is now outdated so posting an updated guide.</p>

<p>Most of the steps come from this <a href="https://github.com/codibly/app-clip-instant-app-react-native/blob/main/Creating-React-Native-AppClip.md">repo</a> kudos to codibly and also all the amazing people that provide all the packages and guides for integrations between old-arch and new-arch.</p>

<ul>
  <li>Add a new target to your project. Select Swift and StoryBoard.</li>
</ul>

<p><img src="https://ospfranco.com/assets/appclip1.jpg" alt="appclip1" /></p>

<ul>
  <li>Add the <code class="language-plaintext highlighter-rouge">@rnx-kit/react-native-host</code>. It’s a package that allows to hoist a RCTRootView in the different architectures</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yarn add @rnx-kit/react-native-host <span class="nt">--dev</span>
</code></pre></div></div>

<ul>
  <li>Modify your <code class="language-plaintext highlighter-rouge">podfile</code></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># In your main app target add the following</span>

  <span class="c1"># Auto linking is broken on this package</span>
  <span class="c1"># https://github.com/microsoft/rnx-kit/issues/3208</span>
  <span class="n">pod</span> <span class="s1">'ReactNativeHost'</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">"../node_modules/@rnx-kit/react-native-host"</span>

  <span class="n">target</span> <span class="s1">'Clip'</span> <span class="k">do</span>
    <span class="n">inherit!</span> <span class="ss">:complete</span>
    <span class="c1"># Pods for Clip</span>
  <span class="k">end</span>
</code></pre></div></div>

<ul>
  <li>Do a new arch pod install</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>ios <span class="o">&amp;&amp;</span> <span class="nv">RCT_NEW_ARCH_ENABLED</span><span class="o">=</span>1 pod <span class="nb">install</span>
</code></pre></div></div>

<ul>
  <li>Create a <code class="language-plaintext highlighter-rouge">BridgeManager.swift</code> class in the Clip target. Make sure it is added to the correct target! This class will help us instantiate a “host” which is compatible with the old arch and new arch.</li>
</ul>

<p><img src="https://ospfranco.com/assets/appclip2.jpg" alt="appclip2" /></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Foundation</span>
<span class="kd">import</span> <span class="kt">React</span>
<span class="kd">import</span> <span class="kt">ReactNativeHost</span>

<span class="kd">class</span> <span class="kt">BridgeManager</span><span class="p">:</span> <span class="kt">NSObject</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">shared</span> <span class="o">=</span> <span class="kt">BridgeManager</span><span class="p">()</span>

    <span class="k">var</span> <span class="nv">host</span><span class="p">:</span> <span class="kt">ReactNativeHost</span><span class="p">?</span>

    <span class="kd">public</span> <span class="kd">func</span> <span class="nf">loadReactNative</span><span class="p">(</span><span class="nv">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="kt">AnyHashable</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?)</span> <span class="p">{</span>
      <span class="n">host</span> <span class="o">=</span> <span class="kt">ReactNativeHost</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">BridgeManager</span><span class="p">:</span> <span class="kt">RNXHostConfig</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">sourceURL</span><span class="p">(</span><span class="k">for</span> <span class="nv">bridge</span><span class="p">:</span> <span class="kt">RCTBridge</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">URL</span><span class="p">?</span> <span class="p">{</span>
        <span class="cp">#if DEBUG</span>
          <span class="k">return</span> <span class="kt">RCTBundleURLProvider</span><span class="o">.</span><span class="nf">sharedSettings</span><span class="p">()</span><span class="o">.</span><span class="nf">jsBundleURL</span><span class="p">(</span><span class="nv">forBundleRoot</span><span class="p">:</span> <span class="s">"index.clip"</span><span class="p">)</span>
        <span class="cp">#else</span>
            <span class="k">return</span> <span class="kt">Bundle</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="nf">url</span><span class="p">(</span><span class="nv">forResource</span><span class="p">:</span> <span class="s">"main"</span><span class="p">,</span> <span class="nv">withExtension</span><span class="p">:</span> <span class="s">"jsbundle"</span><span class="p">)</span>
        <span class="cp">#endif</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In order for the DEBUG preprocessor macro to run, we need to add the DEBUG flag into the build settings of the Clip target</p>

<p><img src="https://ospfranco.com/assets/appclip5.jpg" alt="appclip5" /></p>

<ul>
  <li>We are going to modify the <code class="language-plaintext highlighter-rouge">AppDelegate.m</code> at the Clip target:</li>
</ul>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">React</span>
<span class="kd">import</span> <span class="kt">ReactNativeHost</span>
<span class="kd">import</span> <span class="kt">UIKit</span>

<span class="kd">@main</span>
<span class="kd">class</span> <span class="kt">AppDelegate</span><span class="p">:</span> <span class="kt">UIResponder</span><span class="p">,</span> <span class="kt">UIApplicationDelegate</span><span class="p">,</span> <span class="kt">RNXHostConfig</span> <span class="p">{</span>

  <span class="k">var</span> <span class="nv">window</span><span class="p">:</span> <span class="kt">UIWindow</span><span class="p">?</span>

  <span class="kd">func</span> <span class="nf">sourceURL</span><span class="p">(</span><span class="k">for</span> <span class="nv">bridge</span><span class="p">:</span> <span class="kt">RCTBridge</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">URL</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">application</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span>
    <span class="n">didFinishLaunchingWithOptions</span> <span class="nv">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="kt">UIApplication</span><span class="o">.</span><span class="kt">LaunchOptionsKey</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]?</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="kt">BridgeManager</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">loadReactNative</span><span class="p">(</span><span class="nv">launchOptions</span><span class="p">:</span> <span class="n">launchOptions</span><span class="p">)</span>
    <span class="c1">// Override point for customization after application launch.</span>
    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="c1">// MARK: UISceneSession Lifecycle</span>

  <span class="kd">func</span> <span class="nf">application</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="n">configurationForConnecting</span> <span class="nv">connectingSceneSession</span><span class="p">:</span> <span class="kt">UISceneSession</span><span class="p">,</span>
    <span class="nv">options</span><span class="p">:</span> <span class="kt">UIScene</span><span class="o">.</span><span class="kt">ConnectionOptions</span>
  <span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UISceneConfiguration</span> <span class="p">{</span>
    <span class="c1">// Called when a new scene session is being created.</span>
    <span class="c1">// Use this method to select a configuration to create the new scene with.</span>
    <span class="k">return</span> <span class="kt">UISceneConfiguration</span><span class="p">(</span>
      <span class="nv">name</span><span class="p">:</span> <span class="s">"Default Configuration"</span><span class="p">,</span> <span class="nv">sessionRole</span><span class="p">:</span> <span class="n">connectingSceneSession</span><span class="o">.</span><span class="n">role</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">application</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">application</span><span class="p">:</span> <span class="kt">UIApplication</span><span class="p">,</span> <span class="n">didDiscardSceneSessions</span> <span class="nv">sceneSessions</span><span class="p">:</span> <span class="kt">Set</span><span class="o">&lt;</span><span class="kt">UISceneSession</span><span class="o">&gt;</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Called when the user discards a scene session.</span>
    <span class="c1">// If any sessions were discarded while the application was not running, this will be called shortly after application:didFinishLaunchingWithOptions.</span>
    <span class="c1">// Use this method to release any resources that were specific to the discarded scenes, as they will not return.</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>We can the finally load the <code class="language-plaintext highlighter-rouge">RCTRootView</code> (the view that holds RN) into the app clip controller</li>
</ul>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="kd">import</span> <span class="kt">ReactNativeHost</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

  <span class="k">override</span> <span class="kd">func</span> <span class="nf">loadView</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">host</span> <span class="o">=</span> <span class="kt">BridgeManager</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">host</span> <span class="p">{</span>
          <span class="k">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="nf">view</span><span class="p">(</span>
              <span class="nv">moduleName</span><span class="p">:</span> <span class="s">"clip"</span><span class="p">,</span>
              <span class="nv">initialProperties</span><span class="p">:</span> <span class="kc">nil</span>
          <span class="p">)</span>
      <span class="p">}</span>

  <span class="p">}</span>

    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="c1">// Do any additional setup after loading the view.</span>
    <span class="p">}</span>


<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>At this point you should get the gist of what we are trying to do. Start a RN instance inside the App Clip. However, we now need to take care of a bunch of minutia that is annoying. We are going to copy the contents of the main target <code class="language-plaintext highlighter-rouge">Bundle React Native code and images</code> but modify it so that instead of loading the <code class="language-plaintext highlighter-rouge">index.js</code> file it loads <code class="language-plaintext highlighter-rouge">index.clip.js</code>. Go to build phases, add new script and copy the contents of the script:</li>
</ul>

<p><img src="https://ospfranco.com/assets/appclip3.jpg" alt="appclip3" /></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">WITH_ENVIRONMENT</span><span class="o">=</span><span class="s2">"</span><span class="nv">$REACT_NATIVE_PATH</span><span class="s2">/scripts/xcode/with-environment.sh"</span>
<span class="nv">REACT_NATIVE_XCODE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$REACT_NATIVE_PATH</span><span class="s2">/scripts/react-native-xcode.sh"</span>

/bin/sh <span class="nt">-c</span> <span class="s2">"ENTRY_FILE=index.clip.js </span><span class="nv">$WITH_ENVIRONMENT</span><span class="s2"> </span><span class="nv">$REACT_NATIVE_XCODE</span><span class="s2">"</span>
</code></pre></div></div>

<ul>
  <li>We are going to run into a hermes error. You need to disable <code class="language-plaintext highlighter-rouge">User Script Sandboxing</code> on the build settings of the clip target:</li>
</ul>

<p><img src="https://ospfranco.com/assets/appclip4.jpg" alt="appclip4" /></p>

<ul>
  <li>We can finally create our <code class="language-plaintext highlighter-rouge">index.clip.js</code> at the root of the project</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AppRegistry</span><span class="p">,</span> <span class="nx">View</span><span class="p">,</span> <span class="nx">Text</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">react-native</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">AppClip</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">View</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">Text</span><span class="o">&gt;</span><span class="nx">Hello</span><span class="p">,</span><span class="o">&lt;</span><span class="sr">/Text</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="nx">Text</span><span class="o">&gt;</span><span class="nx">I</span><span class="dl">'</span><span class="s1">m your AppClip!&lt;/Text&gt;
  &lt;/View&gt;
);

AppRegistry.registerComponent("clip", () =&gt; AppClip);
</span></code></pre></div></div>

<p>Notice we are registering the component as <code class="language-plaintext highlighter-rouge">clip</code> which matches the component being loaded at the ViewController.</p>

<p>That’s it, if everything is configured correctly you should be able to see your app clip loaded. You can find the repo of this app <a href="https://github.com/ospfranco/RNAppClip">here</a></p>
</div>
    </div>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
      hljs.highlightAll();
    </script>
  </div>
</body>
</html>
