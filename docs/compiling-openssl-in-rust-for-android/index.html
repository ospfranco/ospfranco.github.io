<head>
  <link rel="preconnect" href="https://rsms.me/" />
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="utf-8" />
  <link
    rel="shortcut icon"
    type="image/x-icon"
    href="/assets/favicon.ico"
  />
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Compiling OpenSSL in Rust for Android | Oscar Franco</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Compiling OpenSSL in Rust for Android" />
<meta name="author" content="Oscar Franco" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="There is now a long standing issue with the latest versions of OpenSSL. The handwritten assembly is incompatible with Position Independent Code. While this issue is not resolved it means the latest versions of OpenSSL do not run on Android." />
<meta property="og:description" content="There is now a long standing issue with the latest versions of OpenSSL. The handwritten assembly is incompatible with Position Independent Code. While this issue is not resolved it means the latest versions of OpenSSL do not run on Android." />
<link rel="canonical" href="https://ospfranco.com/compiling-openssl-in-rust-for-android/" />
<meta property="og:url" content="https://ospfranco.com/compiling-openssl-in-rust-for-android/" />
<meta property="og:site_name" content="Oscar Franco" />
<meta property="og:image" content="https://ospfranco.com/assets/oscar.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-09-21T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://ospfranco.com/assets/oscar.jpg" />
<meta property="twitter:title" content="Compiling OpenSSL in Rust for Android" />
<meta name="twitter:site" content="@ospfranco" />
<meta name="twitter:creator" content="@Oscar Franco" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Oscar Franco"},"dateModified":"2024-09-21T00:00:00+02:00","datePublished":"2024-09-21T00:00:00+02:00","description":"There is now a long standing issue with the latest versions of OpenSSL. The handwritten assembly is incompatible with Position Independent Code. While this issue is not resolved it means the latest versions of OpenSSL do not run on Android.","headline":"Compiling OpenSSL in Rust for Android","image":"https://ospfranco.com/assets/oscar.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://ospfranco.com/compiling-openssl-in-rust-for-android/"},"url":"https://ospfranco.com/compiling-openssl-in-rust-for-android/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/css/site.css" />
</head>

<html>
  <header class="w-full flex flex-col items-center justify-center pt-12 pb-4">
  <!-- <img src="/assets/bg.png" class="" /> -->
  <div class="w-full max-w-4xl flex items-center gap-2 px-4">
    <a href="/" class="flex-1 flex items-center text-black dark:text-white">
      <img src="/assets/oscar.jpg" class="w-8 h-8 rounded-xl mr-2 object-cover" />
      Oscar Franco</a>

    <!-- <div class="h-2 w-2 rounded-full bg-green-400 animate-pulse"></div>
    <a href="mailto:ospfranco@gmail.com"
    target="_blank" class="text-sm">
      Available for freelance work
    </a> -->
  </div>
</header>

<body class="flex flex-col items-center">
  <div class="px-4 pt-8 min-h-screen xl:max-w-4xl w-full">
    <div class="xl:mx-auto flex flex-col">
      <h1 class="text-black dark:text-white text-lg font-semibold sm:text-4xl">
        Compiling OpenSSL in Rust for Android
      </h1>

      <p class="mt-2 text-neutral-500 text-sm">
        September 2024
      </p>

      <div class="pt-4 pb-20 markdown text-justify"><p>There is now a long standing issue with the latest versions of OpenSSL. <a href="https://github.com/openssl/openssl/pull/22181">The handwritten assembly is incompatible with Position Independent Code</a>. While this issue is not resolved it means the latest versions of OpenSSL do not run on Android.</p>

<p>As a side note, the NDK port of <a href="https://github.com/android/ndk/issues/1992">OpenSSL is still on version 1.1.1 which is EOL</a>. This is a huge vunerability for Android but it seems the NDK team has no priority on updating this.</p>

<p>In a client project I’m using Rust which depends on OpenSSL. This has left me no choice other than to patch OpenSSL myself, so I get it to compile to Android platforms.</p>

<h1 id="compiling-openssl">Compiling OpenSSL</h1>

<p>Here is a script that will download and compile OpenSSL for Android directly. It already includes the patching described in the GitHub issue to patch the handcrafted assembly.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Clone or download the sources (it's done for you at below)</span>
<span class="c"># You should most definitely read the ANDROID notes to see the exact command. A lot of the scripts online are outdated for the 1.X branches</span>
<span class="c"># You basically need to set the ANDROID_NDK_HOME variable for this script to work</span>
<span class="c"># Generating the dylibs was failing for me, so disabled it for now</span>

<span class="c">#set -v</span>
<span class="nb">set</span> <span class="nt">-ex</span>

<span class="nb">export </span><span class="nv">OPENSSL_VERSION</span><span class="o">=</span><span class="s2">"openssl-3.3.2"</span>
<span class="nb">rm</span> <span class="nt">-rf</span> <span class="k">${</span><span class="nv">OPENSSL_VERSION</span><span class="k">}</span>
<span class="c"># Sometimes this link breaks, you can manually download the sources yourself</span>
<span class="c"># curl -O "https://github.com/openssl/openssl/releases/download/${OPENSSL_VERSION}/${OPENSSL_VERSION}.tar.gz"</span>
<span class="nb">tar </span>xfz <span class="s2">"</span><span class="k">${</span><span class="nv">OPENSSL_VERSION</span><span class="k">}</span><span class="s2">.tar.gz"</span>

<span class="nv">PROJECT_HOME</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
<span class="nv">PATH_ORG</span><span class="o">=</span><span class="nv">$PATH</span>
<span class="nv">OUTPUT_DIR</span><span class="o">=</span><span class="s2">"libs"</span>

<span class="c"># Clean output:</span>
<span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$OUTPUT_DIR</span>
<span class="nb">mkdir</span> <span class="nv">$OUTPUT_DIR</span>

build_android_clang<span class="o">()</span> <span class="o">{</span>

	<span class="nb">echo</span> <span class="s2">""</span>
	<span class="nb">echo</span> <span class="s2">"----- Build libcrypto &amp; libssl.so for "</span><span class="nv">$1</span><span class="s2">" -----"</span>
	<span class="nb">echo</span> <span class="s2">""</span>

	<span class="nv">ARCHITECTURE</span><span class="o">=</span><span class="nv">$1</span>
	<span class="nv">TOOLCHAIN</span><span class="o">=</span><span class="nv">$2</span>
	<span class="nv">stl</span><span class="o">=</span><span class="s2">"libc++"</span>

	<span class="c"># Set toolchain</span>
	<span class="nb">export </span><span class="nv">TOOLCHAIN_ROOT</span><span class="o">=</span><span class="nv">$ANDROID_NDK_HOME</span>/toolchains/llvm/prebuilt/darwin-x86_64
	<span class="nb">export </span><span class="nv">SYSROOT</span><span class="o">=</span><span class="nv">$TOOLCHAIN_ROOT</span>/sysroot
	<span class="nb">export </span><span class="nv">CC</span><span class="o">=</span><span class="k">${</span><span class="nv">TOOLCHAIN</span><span class="k">}</span>21-clang
	<span class="nb">export </span><span class="nv">CXX</span><span class="o">=</span><span class="k">${</span><span class="nv">TOOLCHAIN</span><span class="k">}</span>21-clang++
	<span class="nb">export </span><span class="nv">CXXFLAGS</span><span class="o">=</span><span class="s2">"-fPIC"</span>
	<span class="nb">export </span><span class="nv">CPPFLAGS</span><span class="o">=</span><span class="s2">"-DANDROID -fPIC"</span>

	<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$TOOLCHAIN_ROOT</span>/bin:<span class="nv">$SYSROOT</span>/usr/local/bin:<span class="nv">$PATH</span>

	<span class="nb">cd</span> <span class="s2">"</span><span class="k">${</span><span class="nv">OPENSSL_VERSION</span><span class="k">}</span><span class="s2">"</span>

	./Configure <span class="nv">$ARCHITECTURE</span> no-asm no-shared <span class="nt">-D__ANDROID_API__</span><span class="o">=</span>21

	make clean
	<span class="c"># Apply patch that fixes the armcap instruction</span>
	<span class="c"># Linux version</span>
	<span class="c"># sed -e '/[.]hidden.*OPENSSL_armcap_P/d; /[.]extern.*OPENSSL_armcap_P/ {p; s/extern/hidden/ }' -i -- crypto/*arm*pl crypto/*/asm/*arm*pl</span>
	<span class="c"># macOS version</span>
	<span class="nb">sed</span> <span class="nt">-E</span> <span class="nt">-i</span> <span class="s1">''</span> <span class="nt">-e</span> <span class="s1">'/[.]hidden.*OPENSSL_armcap_P/d'</span> <span class="nt">-e</span> <span class="s1">'/[.]extern.*OPENSSL_armcap_P/ {p; s/extern/hidden/; }'</span> crypto/<span class="k">*</span>arm<span class="k">*</span>pl crypto/<span class="k">*</span>/asm/<span class="k">*</span>arm<span class="k">*</span>pl

	make

	<span class="nb">mkdir</span> <span class="nt">-p</span> ../<span class="nv">$OUTPUT_DIR</span>/<span class="k">${</span><span class="nv">ARCHITECTURE</span><span class="k">}</span>/lib
	<span class="nb">mkdir</span> <span class="nt">-p</span> ../<span class="nv">$OUTPUT_DIR</span>/<span class="k">${</span><span class="nv">ARCHITECTURE</span><span class="k">}</span>/include

	<span class="nb">cp </span>libcrypto.a ../<span class="nv">$OUTPUT_DIR</span>/<span class="k">${</span><span class="nv">ARCHITECTURE</span><span class="k">}</span>/lib/libcrypto.a
	<span class="nb">cp </span>libssl.a ../<span class="nv">$OUTPUT_DIR</span>/<span class="k">${</span><span class="nv">ARCHITECTURE</span><span class="k">}</span>/lib/libssl.a

	<span class="nb">cp</span> <span class="nt">-R</span> include/openssl ../<span class="nv">$OUTPUT_DIR</span>/<span class="k">${</span><span class="nv">ARCHITECTURE</span><span class="k">}</span>/include

	<span class="nb">cd</span> ..
<span class="o">}</span>

build_android_clang <span class="s2">"android-arm"</span> <span class="s2">"armv7a-linux-androideabi"</span>
build_android_clang <span class="s2">"android-x86"</span> <span class="s2">"i686-linux-android"</span>
build_android_clang <span class="s2">"android-x86_64"</span> <span class="s2">"x86_64-linux-android"</span>
build_android_clang <span class="s2">"android-arm64"</span> <span class="s2">"aarch64-linux-android"</span>
</code></pre></div></div>

<p>This script will create a <code class="language-plaintext highlighter-rouge">libs</code> folder, which contains all the files in the necessary structure.</p>

<h1 id="compiling-rust-crate">Compiling Rust crate</h1>

<p>In order to compile this in your Rust crate you need to first add the crates:</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">openssl</span> <span class="o">=</span><span class="w"> </span><span class="s">"0.10"</span>
<span class="n">openssl-sys</span> <span class="o">=</span><span class="w"> </span><span class="s">"0.9.103"</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">openssl</code> is a bindings crate for the Rust code, but the openssl-sys takes care of compiling/detecting OpenSSL itself.</p>

<p>With this crates added, we can then invoke the compilation command with an added flag <code class="language-plaintext highlighter-rouge">OPENSSL_DIR</code> which <code class="language-plaintext highlighter-rouge">openssl-sys</code> will detect and instead of compiling OpenSSL from source will use the precompiled static libraries we generated.</p>

<p>Here I’m using <code class="language-plaintext highlighter-rouge">cargo-ndk</code> which is a crate that does the SDK/NDK discovery for you so you can easily compile for android. This is a <code class="language-plaintext highlighter-rouge">Makefile</code> version, but you can use whatever you want to point to it to the correct folder that matches the architecture:</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">android-build-release-%</span><span class="o">:</span>
	<span class="p">@</span> <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$*</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"aarch64-linux-android"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="se">\</span>
			<span class="nv">OPENSSL_DIR</span><span class="o">=</span><span class="p">$(</span>CURDIR<span class="p">)</span>/libs/android-arm64<span class="p">;</span> <span class="se">\</span>
	  <span class="k">elif</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$*</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"x86_64-linux-android"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="se">\</span>
	    <span class="nv">OPENSSL_DIR</span><span class="o">=</span><span class="p">$(</span>CURDIR<span class="p">)</span>/libs/android-x86_64<span class="p">;</span> <span class="se">\</span>
	  <span class="k">elif</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$*</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"armv7-linux-androideabi"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="se">\</span>
	    <span class="nv">OPENSSL_DIR</span><span class="o">=</span><span class="p">$(</span>CURDIR<span class="p">)</span>/libs/android-arm<span class="p">;</span> <span class="se">\</span>
	  <span class="k">elif</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$*</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"i686-linux-android"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="se">\</span>
	    <span class="nv">OPENSSL_DIR</span><span class="o">=</span><span class="p">$(</span>CURDIR<span class="p">)</span>/libs/android-x86<span class="p">;</span> <span class="se">\</span>
	  <span class="k">else</span> <span class="se">\</span>
	    <span class="nb">echo</span> <span class="s2">"Unknown target: </span><span class="nv">$*</span><span class="s2">"</span><span class="p">;</span> <span class="se">\</span>
	    <span class="nb">exit </span>1<span class="p">;</span> <span class="se">\</span>
	  <span class="k">fi</span><span class="p">;</span> <span class="se">\</span>
	  <span class="nv">OPENSSL_DIR</span><span class="o">=</span><span class="nv">$$</span>OPENSSL_DIR cargo ndk <span class="nt">--target</span> <span class="nv">$*</span> <span class="nt">--platform</span> 31 build <span class="nt">--release</span> <span class="nt">--all-features</span>
</code></pre></div></div>

<p>Once everything is ready, will not only the Android binary be correct, you will actually be using the latest version of OpenSSL instead of the outdated NDK ports.</p>
</div>
    </div>

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
      hljs.highlightAll();
    </script>
  </div>
</body>
</html>
